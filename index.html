<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PawLog v2.3 ‚Äî Calendar + Quick Add + Cloud Sync</title>
  <style>
    :root{
      --brand:#4CAF50;
      --brand-2:#2e7d32;
      --bg:#f6f7f9;
      --card:#fff;
      --text:#222;
      --muted:#667085;
      --chip:#e8f5e9;
      --chip-2:#c8e6c9;
      --danger:#e53935;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,system-ui,sans-serif;
      background:var(--bg); color:var(--text); display:flex; align-items:center; justify-content:center;
      padding: 16px;
    }
    .shell{width:min(980px,100%);}
    header{display:flex; align-items:center; gap:12px; margin-bottom:12px; justify-content:space-between}
    header h1{color:var(--brand); font-size:24px; margin:0;}
    .card{
      background:var(--card); border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.08);
      padding:16px;
    }
    .grid{display:grid; grid-template-columns: 360px 1fr; gap:16px;}
    @media (max-width: 920px){ .grid{grid-template-columns: 1fr;} }
    .section-title{font-weight:700; margin:4px 0 10px 0;}
    .activity-buttons{display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px;}
    .activity-btn{
      flex:1 1 auto; padding:10px 12px; border-radius:10px; border:2px solid var(--chip);
      background:var(--chip); color:var(--brand-2); font-weight:600; cursor:pointer; transition:.15s ease all;
    }
    .activity-btn:hover{background:#dcedc8}
    .activity-btn.selected{background:var(--chip-2); border-color:var(--brand);}
    label{font-size:12px; text-transform:uppercase; letter-spacing:.04em; color:var(--muted); display:block; margin:8px 0 4px}
    input[type="text"], input[type="number"], input[type="time"], input[type="date"], textarea, select{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid #d0d5dd; font-size:15px;
    }
    textarea{min-height:68px; resize:vertical;}
    .row{display:flex; gap:8px;}
    .row > *{flex:1}
    .chips{display:flex; flex-wrap:wrap; gap:8px; margin:6px 0 0}
    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border-radius:999px; border:1px solid #d0d5dd; background:#fafafa; cursor:pointer;
      font-weight:600; font-size:13px;
    }
    .chip[data-selected="true"]{background:var(--chip); border-color:var(--brand); color:var(--brand-2);}
    .quick-actions{margin-top:8px; padding:10px; background:#fafafa; border:1px dashed #d0d5dd; border-radius:12px;}
    .quick-title{font-size:12px; color:var(--muted); margin-bottom:6px; text-transform:uppercase; letter-spacing:.04em}
    .quick-row{display:flex; flex-wrap:wrap; gap:8px;}
    .quick-btn{
      border:1px solid #d0d5dd; background:#fff; border-radius:999px; padding:8px 10px; font-weight:700; cursor:pointer;
    }
    .submit-btn{
      width:100%; margin-top:10px; background:var(--brand); color:#fff; border:none; border-radius:12px; padding:12px 14px;
      font-weight:700; font-size:16px; cursor:pointer;
    }
    .submit-btn:hover{filter:brightness(.95)}
    .status{min-height:22px; font-weight:700; margin-top:8px;}
    .status.ok{color:var(--brand)}
    .status.err{color:var(--danger)}
    .inline-hint{font-size:12px; color:var(--muted)}
    .divider{height:1px; background:#eee; margin:12px 0}
    .calendar-head{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;}
    .cal-nav{display:flex; gap:8px; align-items:center}
    .cal-btn{ padding:8px 10px; border:1px solid #d0d5dd; border-radius:8px; background:#fff; cursor:pointer; font-weight:600;}
    .calendar{display:grid; grid-template-columns: repeat(7, 1fr); gap:6px;}
    .dow{font-size:12px; font-weight:700; color:var(--muted); text-align:center; padding:6px 0}
    .day{ background:#fff; border:1px solid #eee; border-radius:10px; min-height:96px; padding:6px; display:flex; flex-direction:column; gap:6px;}
    .day.other{opacity:.45}
    .day .date-num{font-weight:700; font-size:13px}
    .pill-row{display:flex; flex-wrap:wrap; gap:4px}
    .pill{ font-size:11px; font-weight:700; padding:4px 6px; border-radius:999px; background:var(--chip); border:1px solid #d0d5dd; white-space:nowrap;}
    .day:hover{outline:2px solid #d0d5dd; cursor:pointer}
    .legend{display:flex; flex-wrap:wrap; gap:6px; font-size:12px; margin-top:8px}
    .legend .pill{background:#fafafa}
    dialog{border:none; border-radius:16px; width:min(560px,95%); padding:0; box-shadow:0 8px 32px rgba(0,0,0,.25)}
    dialog::backdrop{background:rgba(0,0,0,.3)}
    .modal-head{padding:14px 16px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between}
    .modal-body{padding:16px; max-height:70vh; overflow:auto}
    .log-item{border:1px solid #eee; border-radius:10px; padding:10px; display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
    .log-item .meta{font-size:12px; color:var(--muted)}
    .empty{color:var(--muted); font-style:italic}
    .today-strip{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px}
    .today-chip{padding:6px 8px; border-radius:999px; background:#fafafa; border:1px solid #eee; font-weight:700; font-size:12px}
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div style="display:flex; align-items:center; gap:10px">
        <h1>üê∂ PawLog</h1>
        <div class="inline-hint">v2.3 ‚Äî Calendar + Quick Add + Cloud Sync</div>
      </div>
      <div class="cal-nav">
        <button class="cal-btn" id="syncBtn">‚ü≥ Sync</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="section-title">Quick Log</div>
        <div class="activity-buttons" id="activityButtons">
          <button type="button" class="activity-btn" data-activity="Feeding">üêæ Feeding</button>
          <button type="button" class="activity-btn" data-activity="Walk">üö∂ Walk</button>
          <button type="button" class="activity-btn" data-activity="Bathroom">üí© Bathroom</button>
          <button type="button" class="activity-btn" data-activity="Medication">üíä Medication</button>
          <button type="button" class="activity-btn" data-activity="Vet Visit">üè• Vet Visit</button>
        </div>

        <div class="row">
          <div>
            <label for="dateInput">Date</label>
            <input id="dateInput" type="date"/>
          </div>
          <div>
            <label for="timeInput">Time</label>
            <input id="timeInput" type="time" />
          </div>
        </div>

        <div id="quickActions" class="quick-actions" style="display:none">
          <div class="quick-title">Quick Add (uses current date & time)</div>
          <div id="quickRow" class="quick-row"></div>
        </div>

        <div id="dynamicFields"></div>

        <label for="notesInput">Notes (optional)</label>
        <textarea id="notesInput" placeholder="Any extra details..."></textarea>

        <button class="submit-btn" id="submitBtn">Log Activity</button>
        <div class="status" id="status"></div>
        <div class="inline-hint">Posts to your Google Apps Script sheet and caches locally for the calendar.</div>

        <div class="divider"></div>
        <div class="section-title">Today</div>
        <div id="todayStrip" class="today-strip"></div>
      </section>

      <section class="card">
        <div class="calendar-head">
          <div class="section-title" id="monthLabel">Month</div>
          <div class="cal-nav">
            <button class="cal-btn" id="prevBtn">‚óÄÔ∏é</button>
            <button class="cal-btn" id="todayBtn">Today</button>
            <button class="cal-btn" id="nextBtn">‚ñ∂Ô∏é</button>
          </div>
        </div>
        <div class="calendar" id="calendarGrid"></div>
        <div class="legend">
          <span class="pill">Feeding</span>
          <span class="pill">Walk</span>
          <span class="pill">Bathroom</span>
          <span class="pill">Medication</span>
          <span class="pill">Vet Visit</span>
        </div>
      </section>
    </div>
  </div>

  <dialog id="dayModal">
    <div class="modal-head">
      <div id="dayModalTitle">Logs</div>
      <button class="cal-btn" id="closeModal">Close</button>
    </div>
    <div class="modal-body">
      <div id="logsOnDay"></div>
    </div>
  </dialog>

  <script>
    // ===== Config =====
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzA8CPdsAdOt_Ga4eIPtrZMlTrhSFW187HMxomY_Alzu1IhUCjxjGVQ8uewbHT19lb19w/exec';
    const USER_NAME = 'Default User';
    const LS_KEY = 'pawlog-entries-v1';

    // ===== Utilities =====
    const pad = (n) => String(n).padStart(2,'0');
    const toDateKey = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    function setDefaultDateTime(){
      const d = document.getElementById('dateInput');
      const t = document.getElementById('timeInput');
      const now = new Date();
      d.value = now.toISOString().slice(0,10);
      t.value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
    }

    function loadCache(){ try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch(e){ return []; } }
    function saveCache(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
    function upsertMany(entries){
      const map = new Map(loadCache().map(e => [e.id, e]));
      for(const e of entries){ map.set(e.id, e); }
      const merged = Array.from(map.values()).sort((a,b)=> a.timestamp.localeCompare(b.timestamp));
      saveCache(merged);
      renderCalendar(currentMonth.getFullYear(), currentMonth.getMonth());
      renderTodayStrip();
    }
    function addToCache(entry){ upsertMany([entry]); }
    function entriesByDateKey(){
      const out = {};
      for(const e of loadCache()){
        const k = e.dateKey; if(!out[k]) out[k] = []; out[k].push(e);
      }
      return out;
    }

    // ===== Dynamic + Quick actions per activity =====
    const dynamicFields = document.getElementById('dynamicFields');
    const quickBox = document.getElementById('quickActions');
    const quickRow = document.getElementById('quickRow');
    let currentActivity = null;

    function renderQuickActions(activity){
      quickRow.innerHTML = '';
      let opts = [];
      if(activity === 'Feeding'){
        opts = [
          {label:'feed 0.5 scoops', payload:{amount:0.5}},
          {label:'feed 1.0 scoops', payload:{amount:1.0}},
          {label:'feed 1.5 scoops', payload:{amount:1.5}},
        ];
      } else if(activity === 'Walk'){
        opts = [
          {label:'walk 15 minutes', payload:{minutes:15}},
          {label:'walk 30 minutes', payload:{minutes:30}},
          {label:'walk 45 minutes', payload:{minutes:45}},
          {label:'walk 60 minutes', payload:{minutes:60}},
        ];
      } else if(activity === 'Bathroom'){
        opts = [
          {label:'bathroom ‚Äî pee', payload:{type:'Pee'}},
          {label:'bathroom ‚Äî poop', payload:{type:'Poop'}},
          {label:'bathroom ‚Äî both', payload:{type:'Both'}},
        ];
      } else if(activity === 'Medication'){
        opts = [
          {label:'trazodone 25 mg', payload:{medName:'Trazodone', mg:25}},
          {label:'trazodone 50 mg', payload:{medName:'Trazodone', mg:50}},
          {label:'trazodone 75 mg', payload:{medName:'Trazodone', mg:75}},
          {label:'trazodone 100 mg', payload:{medName:'Trazodone', mg:100}},
        ];
      } else if(activity === 'Vet Visit'){
        opts = [
          {label:'vet visit ‚Äî check-up', payload:{reason:'check-up'}},
          {label:'vet visit ‚Äî vaccine', payload:{reason:'vaccine'}},
          {label:'vet visit ‚Äî post-op', payload:{reason:'post-op'}},
        ];
      }

      for(const opt of opts){
        const b = document.createElement('button');
        b.className = 'quick-btn';
        b.type = 'button';
        b.textContent = opt.label;
        b.addEventListener('click', ()=> quickAdd(activity, opt.payload));
        quickRow.appendChild(b);
      }
      quickBox.style.display = opts.length ? '' : 'none';
    }

    function renderFields(activity){
      dynamicFields.innerHTML = '';
      renderQuickActions(activity);

      if(activity === 'Feeding'){
        dynamicFields.innerHTML = `
          <label>Custom Feeding</label>
          <div class="chips" id="feedChips">
            <button type="button" class="chip" data-value="0.5">0.5 scoops</button>
            <button type="button" class="chip" data-value="1.0">1.0 scoops</button>
            <button type="button" class="chip" data-value="1.5">1.5 scoops</button>
          </div>
          <div class="row" style="margin-top:6px">
            <div>
              <label for="feedAmount">Amount</label>
              <input id="feedAmount" type="number" min="0" step="0.5" placeholder="e.g., 1.0"/>
            </div>
            <div>
              <label for="foodType">Food Type</label>
              <input id="foodType" type="text" placeholder="kibble / wet / treat"/>
            </div>
          </div>
        `;
        hookChipGroup('feedChips', 'feedAmount');
      }
      else if(activity === 'Walk'){
        dynamicFields.innerHTML = `
          <label>Custom Walk</label>
          <div class="chips" id="walkChips">
            <button type="button" class="chip" data-value="15">15 minutes</button>
            <button type="button" class="chip" data-value="30">30 minutes</button>
            <button type="button" class="chip" data-value="45">45 minutes</button>
            <button type="button" class="chip" data-value="60">60 minutes</button>
          </div>
          <div style="margin-top:6px">
            <label for="walkMins">Duration</label>
            <input id="walkMins" type="number" min="0" step="15" placeholder="e.g., 30"/>
          </div>
        `;
        hookChipGroup('walkChips', 'walkMins');
      }
      else if(activity === 'Bathroom'){
        dynamicFields.innerHTML = `
          <label>Bathroom Type</label>
          <div class="chips" id="bathChips">
            <button type="button" class="chip" data-value="Pee">Pee</button>
            <button type="button" class="chip" data-value="Poop">Poop</button>
            <button type="button" class="chip" data-value="Both">Both</button>
          </div>
        `;
        hookChipGroup('bathChips', null);
      }
      else if(activity === 'Medication'){
        dynamicFields.innerHTML = `
          <label>Medication</label>
          <div class="row">
            <div>
              <select id="medName">
                <option value="Trazodone" selected>Trazodone</option>
                <option value="Other">Other‚Ä¶</option>
              </select>
            </div>
            <div>
              <input id="medNameCustom" type="text" placeholder="Name (if Other)" style="display:none"/>
            </div>
          </div>
          <label>Dosage</label>
          <div class="chips" id="medChips">
            <button type="button" class="chip" data-value="25">25 mg</button>
            <button type="button" class="chip" data-value="50">50 mg</button>
            <button type="button" class="chip" data-value="75">75 mg</button>
            <button type="button" class="chip" data-value="100">100 mg</button>
          </div>
          <div style="margin-top:6px">
            <label for="medMg">Custom (mg)</label>
            <input id="medMg" type="number" min="0" step="25" placeholder="e.g., 25"/>
          </div>
        `;
        hookChipGroup('medChips', 'medMg');
        setTimeout(()=>{
          const medName = document.getElementById('medName');
          const medCustom = document.getElementById('medNameCustom');
          medName.addEventListener('change', ()=>{
            medCustom.style.display = medName.value === 'Other' ? '' : 'none';
          });
        });
      }
      else if(activity === 'Vet Visit'){
        dynamicFields.innerHTML = `
          <label for="vetReason">Reason</label>
          <input id="vetReason" type="text" placeholder="e.g., check-up, vaccine, post-op"/>
        `;
      }
    }

    function hookChipGroup(groupId, inputId){
      const group = document.getElementById(groupId);
      if(!group) return;
      const chips = [...group.querySelectorAll('.chip')];
      const input = inputId ? document.getElementById(inputId) : null;
      chips.forEach(ch => {
        ch.addEventListener('click', ()=>{
          const selected = ch.getAttribute('data-selected') === 'true';
          chips.forEach(c => c.setAttribute('data-selected','false'));
          ch.setAttribute('data-selected', selected ? 'false' : 'true');
          if(input){ input.value = selected ? '' : ch.dataset.value; }
        });
      });
    }

    // ===== Activity selection =====
    const activityButtons = document.getElementById('activityButtons').querySelectorAll('.activity-btn');
    activityButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        activityButtons.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        currentActivity = btn.dataset.activity;
        setDefaultDateTime();
        renderFields(currentActivity);
      });
    });

    // ===== Build common entry + post helpers =====
    function getSelectedDateTime(){
      const now = new Date();
      const d = document.getElementById('dateInput').value || now.toISOString().slice(0,10);
      const t = document.getElementById('timeInput').value || `${pad(now.getHours())}:${pad(now.getMinutes())}`;
      const [y,m,dd] = d.split('-').map(Number);
      const [hh,mm] = t.split(':').map(Number);
      return new Date(y, m-1, dd, hh||0, mm||0);
    }

    function optimisticSave(entry, notes=''){
      addToCache(entry);
      // Post to Sheet
      const payload = {
        Timestamp: new Date(entry.timestamp).toLocaleString(),
        Activity: entry.activity,
        Description: entry.description,
        Notes: notes || '',
        User: USER_NAME
      };
      fetch(APPS_SCRIPT_URL, {
        method:'POST', mode:'no-cors',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      }).catch(()=>{});
    }

    function makeIdFrom(entry){
      // Deterministic id from timestamp + activity + description
      return btoa(unescape(encodeURIComponent(`${entry.timestamp}|${entry.activity}|${entry.description}`))).replace(/=+$/,'');
    }

    function quickAdd(activity, payload){
      const status = document.getElementById('status');
      const ts = getSelectedDateTime();
      const dateKey = toDateKey(ts);

      let description = activity;
      let qty=null, unit='';

      if(activity === 'Feeding'){
        const amount = payload.amount;
        description = `feed ${amount} scoops`;
        qty = amount; unit = 'scoops';
      } else if(activity === 'Walk'){
        const minutes = payload.minutes;
        description = `walk ${minutes} minutes`;
        qty = minutes; unit = 'minutes';
      } else if(activity === 'Bathroom'){
        const type = payload.type;
        description = `bathroom ‚Äî ${type.toLowerCase()}`;
      } else if(activity === 'Medication'){
        const name = payload.medName || 'Medication';
        const mg = payload.mg || null;
        description = `${name.toLowerCase()} ${mg ? mg + ' mg' : ''}`.trim();
        qty = mg; unit = 'mg';
      } else if(activity === 'Vet Visit'){
        const reason = payload.reason || '';
        description = reason ? `vet visit ‚Äî ${reason}` : 'vet visit';
      }

      const entry = {
        id: 'L' + Date.now(), // temporary id
        timestamp: ts.toISOString(),
        dateKey,
        activity,
        description,
        notes: '',
        qty, unit,
        ...payload
      };
      entry.id = makeIdFrom(entry);

      optimisticSave(entry);
      status.textContent = 'Saved! (Quick Add)'; status.className = 'status ok';
      setDefaultDateTime();
    }

    // ===== Submit (custom) =====
    document.getElementById('submitBtn').addEventListener('click', async () => {
      const status = document.getElementById('status');
      if(!currentActivity){
        status.textContent = 'Please select an activity.'; status.className = 'status err'; return;
      }
      const ts = getSelectedDateTime();
      const dateKey = toDateKey(ts);
      const notes = document.getElementById('notesInput').value.trim();

      let description = '', qty = null, unit = '', extra = {};

      if(currentActivity === 'Feeding'){
        const amount = parseFloat(document.getElementById('feedAmount')?.value || '0') || null;
        const foodType = document.getElementById('foodType')?.value?.trim() || '';
        qty = amount; unit = 'scoops';
        description = amount ? `feed ${amount} scoops` : 'feeding';
        if(foodType) description += ` ‚Äî ${foodType}`;
        extra = { amount, foodType };
      }
      else if(currentActivity === 'Walk'){
        const mins = parseFloat(document.getElementById('walkMins')?.value || '0') || null;
        qty = mins; unit = 'minutes';
        description = mins ? `walk ${mins} minutes` : 'walk';
        extra = { minutes: mins };
      }
      else if(currentActivity === 'Bathroom'){
        const chip = document.querySelector('#bathChips .chip[data-selected="true"]');
        const type = chip ? chip.getAttribute('data-value') : '';
        description = type ? `bathroom ‚Äî ${type.toLowerCase()}` : 'bathroom';
        extra = { type };
      }
      else if(currentActivity === 'Medication'){
        const medSel = document.getElementById('medName').value;
        const medName = medSel === 'Other' ? (document.getElementById('medNameCustom').value.trim() || 'Medication') : medSel;
        const mg = parseFloat(document.getElementById('medMg')?.value || '0') || null;
        qty = mg; unit = 'mg';
        description = mg ? `${medName.toLowerCase()} ${mg} mg` : medName.toLowerCase();
        extra = { medName, mg };
      }
      else if(currentActivity === 'Vet Visit'){
        const reason = document.getElementById('vetReason')?.value?.trim() || '';
        description = reason ? `vet visit ‚Äî ${reason}` : 'vet visit';
        extra = { reason };
      }

      const entry = {
        id: 'L' + Date.now(),
        timestamp: ts.toISOString(),
        dateKey,
        activity: currentActivity,
        description,
        notes,
        qty, unit,
        ...extra
      };
      entry.id = makeIdFrom(entry);

      optimisticSave(entry, notes);
      status.textContent = 'Saved!'; status.className = 'status ok';

      document.getElementById('notesInput').value = '';
      renderFields(currentActivity);
      setDefaultDateTime();
    });

    // ===== Calendar =====
    const calendarGrid = document.getElementById('calendarGrid');
    const monthLabel = document.getElementById('monthLabel');
    const dayModal = document.getElementById('dayModal');
    const logsOnDay = document.getElementById('logsOnDay');
    const dayModalTitle = document.getElementById('dayModalTitle');

    let nowRef = new Date();
    let currentMonth = new Date(nowRef.getFullYear(), nowRef.getMonth(), 1);

    function renderCalendar(year, monthIndex){
      const firstDay = new Date(year, monthIndex, 1);
      const lastDay = new Date(year, monthIndex + 1, 0);
      const startWeekDay = (firstDay.getDay()+6)%7; // Monday=0
      const daysInMonth = lastDay.getDate();

      monthLabel.textContent = firstDay.toLocaleString(undefined, {month:'long', year:'numeric'});
      calendarGrid.innerHTML = '';

      const dows = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
      dows.forEach(d => {
        const el = document.createElement('div');
        el.className = 'dow'; el.textContent = d; calendarGrid.appendChild(el);
      });

      const cells = [];
      const daysFromPrev = startWeekDay;
      const prevLast = new Date(year, monthIndex, 0).getDate();

      for(let i=daysFromPrev; i>0; i--){
        cells.push({date:new Date(year, monthIndex-1, prevLast - i + 1), other:true});
      }
      for(let d=1; d<=daysInMonth; d++){
        cells.push({date:new Date(year, monthIndex, d), other:false});
      }
      while(cells.length % 7 !== 0){
        const nextIndex = cells.length - daysFromPrev - daysInMonth + 1;
        cells.push({date:new Date(year, monthIndex+1, nextIndex), other:true});
      }

      const byDate = entriesByDateKey();

      for(const cell of cells){
        const el = document.createElement('div');
        el.className = 'day' + (cell.other ? ' other' : '');
        const dateNum = document.createElement('div');
        dateNum.className = 'date-num';
        dateNum.textContent = cell.date.getDate();
        el.appendChild(dateNum);

        const pk = toDateKey(cell.date);
        const logs = byDate[pk] || [];

        if(logs.length){
          const counts = logs.reduce((acc,e)=>{ acc[e.activity] = (acc[e.activity]||0) + 1; return acc; },{});
          const row = document.createElement('div'); row.className='pill-row';
          for(const [act,count] of Object.entries(counts)){
            const pill = document.createElement('div'); pill.className='pill';
            pill.textContent = `${act} √ó${count}`;
            row.appendChild(pill);
          }
          el.appendChild(row);
        }

        el.addEventListener('click', ()=> openDay(pk, cell.date));
        calendarGrid.appendChild(el);
      }
    }

    function openDay(dateKey, dateObj){
      dayModalTitle.textContent = dateObj.toLocaleDateString(undefined, { weekday:'long', month:'short', day:'numeric', year:'numeric'});
      const logs = (entriesByDateKey()[dateKey] || []).sort((a,b)=> a.timestamp.localeCompare(b.timestamp));
      logsOnDay.innerHTML = '';
      if(!logs.length){
        logsOnDay.innerHTML = '<div class="empty">No entries yet.</div>';
      }else{
        for(const e of logs){
          const row = document.createElement('div');
          row.className = 'log-item';
          const left = document.createElement('div');
          const time = new Date(e.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
          left.innerHTML = `<strong>${e.activity}</strong> ‚Äî ${e.description}<div class="meta">${time}${e.notes? ' ¬∑ ' + e.notes : ''}</div>`;
          const right = document.createElement('div');
          right.className='meta';
          right.textContent = e.qty ? `${e.qty} ${e.unit}` : '';
          row.appendChild(left); row.appendChild(right);
          logsOnDay.appendChild(row);
        }
      }
      document.getElementById('dateInput').value = dateKey;
      dayModal.showModal();
    }
    document.getElementById('closeModal').addEventListener('click', ()=> dayModal.close());
    document.getElementById('prevBtn').addEventListener('click', ()=>{
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1, 1);
      renderCalendar(currentMonth.getFullYear(), currentMonth.getMonth());
    });
    document.getElementById('nextBtn').addEventListener('click', ()=>{
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 1);
      renderCalendar(currentMonth.getFullYear(), currentMonth.getMonth());
    });
    document.getElementById('todayBtn').addEventListener('click', ()=>{
      nowRef = new Date();
      currentMonth = new Date(nowRef.getFullYear(), nowRef.getMonth(), 1);
      renderCalendar(currentMonth.getFullYear(), currentMonth.getMonth());
      setDefaultDateTime();
    });

    function renderTodayStrip(){
      const wrap = document.getElementById('todayStrip');
      wrap.innerHTML = '';
      const todayKey = toDateKey(new Date());
      const logs = (entriesByDateKey()[todayKey] || []);
      if(!logs.length){ wrap.innerHTML = '<span class="today-chip">No logs yet</span>'; return; }
      const byAct = logs.reduce((a,e)=>{ (a[e.activity]=a[e.activity]||[]).push(e); return a; },{});
      for(const [act, arr] of Object.entries(byAct)){
        const chip = document.createElement('div');
        chip.className = 'today-chip';
        chip.textContent = `${act} √ó${arr.length}`;
        wrap.appendChild(chip);
      }
    }

    // ===== Cloud sync (GET) =====
    async function fetchHistorical(days = 120){
      const since = new Date(Date.now() - days*24*60*60*1000);
      const sinceStr = since.toISOString().slice(0,10);
      const url = APPS_SCRIPT_URL + '?since=' + encodeURIComponent(sinceStr);
      try{
        const res = await fetch(url, { method:'GET' });
        if(!res.ok){ throw new Error('HTTP ' + res.status); }
        const json = await res.json();
        // Expect array of rows with keys matching your sheet columns
        const normalized = json.map(r => {
          const ts = new Date(r.Timestamp);
          const activity = r.Activity || 'Log';
          const description = r.Description || '';
          const notes = r.Notes || '';
          const entry = {
            id: '', // fill below
            timestamp: ts.toISOString(),
            dateKey: toDateKey(ts),
            activity,
            description,
            notes,
            qty: null,
            unit: ''
          };
          entry.id = makeIdFrom(entry);
          return entry;
        });
        upsertMany(normalized);
        document.getElementById('status').textContent = 'Synced ' + normalized.length + ' logs from Sheet.';
        document.getElementById('status').className = 'status ok';
      }catch(err){
        console.error('Sync failed', err);
        document.getElementById('status').textContent = 'Sync failed (check Apps Script doGet).';
        document.getElementById('status').className = 'status err';
      }
    }

    document.getElementById('syncBtn').addEventListener('click', ()=> fetchHistorical(365));

    // Init
    setDefaultDateTime();
    renderCalendar(currentMonth.getFullYear(), currentMonth.getMonth());
    renderTodayStrip();
    // Auto-fetch last 4 months on first load
    fetchHistorical(120);
  </script>
</body>
</html>
