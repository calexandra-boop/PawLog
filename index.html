<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
<title>PawLog ‚Äî iOS Mobile</title>

<!-- iOS PWA-ish meta -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#4CAF50">

<style>
:root{
--brand:#4CAF50;
--brand-2:#2e7d32;
--bg:#f7f8fa;
--card:#ffffff;
--text:#111;
--muted:#6b7280;
--line:#e5e7eb;
--chip:#e8f5e9;
--chip-2:#c8e6c9;
--danger:#ef4444;
--safe-top: env(safe-area-inset-top);
--safe-bottom: env(safe-area-inset-bottom);
--safe-left: env(safe-area-inset-left);
--safe-right: env(safe-area-inset-right);
}

*{box-sizing:border-box; -webkit-tap-highlight-color: rgba(0,0,0,0);}
html,body{height:100%}
html{-webkit-text-size-adjust:100%}

body{
margin:0;
font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, system-ui, sans-serif;
background:var(--bg); color:var(--text);
padding: calc(8px + var(--safe-top)) 10px calc(86px + var(--safe-bottom)) 10px; /* bottom room for sticky quickbar */
overscroll-behavior-y: contain; /* gentler pull-to-refresh */
}

/* Header */
header{
position: sticky; top:0; z-index:10;
padding: 10px 8px;
margin: -10px -10px 8px -10px;
padding-top: calc(10px + var(--safe-top));
background: linear-gradient(to bottom, rgba(247,248,250,0.97), rgba(247,248,250,0.6));
backdrop-filter: saturate(180%) blur(8px);
border-bottom:1px solid var(--line);
display:flex; align-items:center; justify-content:space-between; gap:8px;
}
.h-title{display:flex; align-items:center; gap:8px}
.h-title h1{font-size:20px; color:var(--brand); margin:0}
.h-sub{font-size:12px; color:var(--muted)}

/* Card */
.card{
background:var(--card); border-radius:14px; border:1px solid var(--line);
padding:12px;
}

/* Activity row: thumb-friendly horizontal scroll */
.activity-buttons{
display:flex; gap:8px; overflow:auto; padding-bottom:6px; margin-bottom:8px;
-webkit-overflow-scrolling: touch;
scroll-snap-type:x proximity;
}
.activity-btn{
flex:0 0 auto; padding:12px 14px; border-radius:12px; border:2px solid var(--chip);
background:var(--chip); color:var(--brand-2); font-weight:700; font-size:14px; cursor:pointer;
scroll-snap-align:start;
}
.activity-btn.selected{background:var(--chip-2); border-color:var(--brand);}
.section-title{font-weight:800; margin:2px 0 8px 2px; font-size:14px}

/* Inputs (16px to avoid iOS zoom) */
label{font-size:12px; text-transform:uppercase; letter-spacing:.04em; color:var(--muted); display:block; margin:8px 2px 4px}
input[type="text"], input[type="number"], input[type="time"], input[type="date"], textarea, select{
width:100%; padding:14px 12px; border-radius:12px; border:1px solid var(--line); font-size:16px;
background:#fff;
}
textarea{min-height:68px; resize:vertical;}
.row{display:flex; gap:8px;}
.row > *{flex:1}
.chips{display:flex; flex-wrap:wrap; gap:8px; margin:6px 0 0}
.chip{
display:inline-flex; align-items:center; gap:6px; padding:10px 12px; border-radius:999px; border:1px solid var(--line); background:#f9fafb; cursor:pointer;
font-weight:700; font-size:14px;
}
.chip[data-selected="true"]{background:var(--chip); border-color:var(--brand); color:var(--brand-2);}

.submit-btn{
width:100%; margin-top:10px; background:var(--brand); color:#fff; border:none; border-radius:12px; padding:14px 16px;
font-weight:800; font-size:16px; cursor:pointer;
}
.submit-btn:active{transform: translateY(1px)}

.status{min-height:22px; font-weight:800; margin-top:8px;}
.status.ok{color:#16a34a}
.status.err{color:var(--danger)}
.inline-hint{font-size:12px; color:var(--muted)}

/* Sticky Quick Add bar */
.quickbar{
position: fixed; left:0; right:0; bottom:0; z-index:20;
padding: 8px 10px calc(8px + var(--safe-bottom)) 10px;
background: rgba(255,255,255,0.98);
backdrop-filter: blur(8px);
border-top:1px solid var(--line);
}
.quick-title{font-size:11px; color:var(--muted); margin:0 0 6px 2px; text-transform:uppercase; letter-spacing:.04em}
.quick-row{display:flex; gap:8px; overflow:auto; -webkit-overflow-scrolling: touch;}
.quick-btn{
flex:0 0 auto; border:1px solid var(--line); background:#fff; border-radius:999px; padding:10px 12px; font-weight:800; font-size:14px;
}

/* Calendar */
.calendar{margin-top:10px}
.calendar-head{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;}
.cal-nav{display:flex; gap:8px;}
.cal-btn{ padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; font-weight:700;}
.dow-row{display:grid; grid-template-columns: repeat(7, 1fr); gap:4px; padding:0 2px}
.dow{font-size:11px; font-weight:800; color:var(--muted); text-align:center; padding:4px 0}
.grid{display:grid; grid-template-columns: repeat(7, 1fr); gap:4px;}
.day{
background:#fff; border:1px solid var(--line); border-radius:10px; min-height:74px; padding:6px; display:flex; flex-direction:column; gap:4px;
}
.day.other{opacity:.4}
.day .date-num{font-weight:800; font-size:12px}
.pill-row{display:flex; flex-wrap:wrap; gap:4px}
.pill{ font-size:10px; font-weight:800; padding:3px 6px; border-radius:999px; background:var(--chip); border:1px solid var(--line); white-space:nowrap;}
.day:active{outline:2px solid var(--chip-2)}

.legend{display:flex; flex-wrap:wrap; gap:6px; font-size:12px; margin-top:8px}
.legend .pill{background:#f9fafb}

/* Day modal */
dialog{border:none; border-radius:16px; width:100%; max-width:560px; padding:0; box-shadow:0 8px 32px rgba(0,0,0,.25)}
dialog::backdrop{background:rgba(0,0,0,.35)}
.modal-head{position:sticky; top:0; background:#fff; padding:12px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between}
.modal-body{padding:12px; max-height:70vh; overflow:auto}
.log-item{border:1px solid var(--line); border-radius:12px; padding:10px; display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
.log-item .meta{font-size:12px; color:var(--muted)}
.empty{color:var(--muted); font-style:italic}

/* Today strip */
.today-strip{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px}
.today-chip{padding:6px 8px; border-radius:999px; background:#f9fafb; border:1px solid var(--line); font-weight:800; font-size:12px}

/* Dark mode */
@media (prefers-color-scheme: dark){
:root{ --bg:#0b0e11; --card:#0f1317; --text:#eee; --muted:#9aa4b2; --line:#1f2937; --chip:#0e2011; --chip-2:#14361a; }
.quickbar{background: rgba(16,20,24,0.98);}
}
</style>
</head>
<body>
<!-- HEADER -->
<header>
<div class="h-title">
<div>üê∂</div>
<h1>PawLog</h1>
</div>
<div class="h-sub">Mobile ‚Ä¢ iOS</div>
</header>

<!-- MAIN -->
<main>
<!-- Quick Log -->
<section class="card">
<div class="section-title">Quick Log</div>

<div class="activity-buttons" id="activityButtons">
<button type="button" class="activity-btn" data-activity="Feeding">üêæ Feeding</button>
<button type="button" class="activity-btn" data-activity="Walk">üö∂ Walk</button>
<button type="button" class="activity-btn" data-activity="Bathroom">üí© Bathroom</button>
<button type="button" class="activity-btn" data-activity="Medication">üíä Medication</button>
<button type="button" class="activity-btn" data-activity="Vet Visit">üè• Vet Visit</button>
</div>

<div class="row">
<div>
<label for="dateInput">Date</label>
<input id="dateInput" type="date"/>
</div>
<div>
<label for="timeInput">Time</label>
<input id="timeInput" type="time" />
</div>
</div>

<!-- Custom fields injected here -->
<div id="dynamicFields"></div>

<label for="notesInput">Notes (optional)</label>
<textarea id="notesInput" placeholder="Any extra details..."></textarea>

<button class="submit-btn" id="submitBtn">Log Activity</button>
<div class="status" id="status"></div>
<div class="inline-hint">Uses your Apps Script + local cache.</div>

<div class="section-title" style="margin-top:12px">Today</div>
<div id="todayStrip" class="today-strip"></div>
</section>

<!-- Calendar -->
<section class="calendar">
<div class="calendar-head">
<div class="section-title" id="monthLabel">Month</div>
<div class="cal-nav">
<button class="cal-btn" id="syncBtn">Sync</button>
<button class="cal-btn" id="prevBtn">‚óÄÔ∏é</button>
<button class="cal-btn" id="todayBtn">Today</button>
<button class="cal-btn" id="nextBtn">‚ñ∂Ô∏é</button>
</div>
</div>

<div class="dow-row" id="dowRow"></div>
<div class="grid" id="calendarGrid"></div>

<div class="legend">
<span class="pill">Feeding</span>
<span class="pill">Walk</span>
<span class="pill">Bathroom</span>
<span class="pill">Medication</span>
<span class="pill">Vet Visit</span>
</div>
</section>
</main>

<!-- Sticky Quick Bar -->
<div id="quickbar" class="quickbar" style="display:none">
<div class="quick-title">Quick Add ‚Äî uses current date/time</div>
<div id="quickRow" class="quick-row"></div>
</div>

<!-- Day Modal -->
<dialog id="dayModal">
<div class="modal-head">
<div id="dayModalTitle">Logs</div>
<button class="cal-btn" id="closeModal">Close</button>
</div>
<div class="modal-body">
<div id="logsOnDay"></div>
</div>
</dialog>

<script>
// ===== Config =====
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxjJY9PI_ZlrsANEZXcXWJX92tIrKa4Nd9WbEP9_fONxzRpXBtR3l4SXtZ5d_mxhmXBcA/exec';
const USER_NAME = 'Default User';
const LS_KEY = 'pawlog-entries-v1';
const DEDUPE_KEY = 'pawlog-ids-v1';

// ===== Utilities =====
const pad = (n) => String(n).padStart(2,'0');
const toDateKey = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
function setDefaultDateTime(){
const d = document.getElementById('dateInput');
const t = document.getElementById('timeInput');
const now = new Date();
d.value = now.toISOString().slice(0,10);
t.value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
}
function loadCache(){ try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch(e){ return []; } }
function saveCache(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
function addToCache(entry){ const arr = loadCache(); arr.push(entry); saveCache(arr); }
function entriesByDateKey(){
const out = {}; for(const e of loadCache()){ const k = e.dateKey; (out[k]||(out[k]=[])).push(e); } return out;
}
function idSet(){ try{return new Set(JSON.parse(localStorage.getItem(DEDUPE_KEY)||'[]'))}catch(e){return new Set()}}
function saveIdSet(s){ localStorage.setItem(DEDUPE_KEY, JSON.stringify(Array.from(s))); }

// Smaller UX niceties on iOS
// Ensure inputs remain visible when keyboard opens
document.addEventListener('focusin', (e) => {
if (e.target.matches('input, textarea, select')) {
setTimeout(()=> e.target.scrollIntoView({block:'center', behavior:'smooth'}), 50);
}
});

// ===== UI: Activity + QuickBar =====
const dynamicFields = document.getElementById('dynamicFields');
const quickbar = document.getElementById('quickbar');
const quickRow = document.getElementById('quickRow');
let currentActivity = null;

function showQuickBar(activity){
quickRow.innerHTML = '';
let opts = [];
if(activity === 'Feeding'){
opts = [
{label:'feed 0.5 scoops', payload:{amount:0.5}},
{label:'feed 1.0 scoops', payload:{amount:1.0}},
{label:'feed 1.5 scoops', payload:{amount:1.5}},
];
} else if(activity === 'Walk'){
opts = [
{label:'walk 15 minutes', payload:{minutes:15}},
{label:'walk 30 minutes', payload:{minutes:30}},
{label:'walk 45 minutes', payload:{minutes:45}},
{label:'walk 60 minutes', payload:{minutes:60}},
];
} else if(activity === 'Bathroom'){
opts = [
{label:'bathroom ‚Äî pee', payload:{type:'Pee'}},
{label:'bathroom ‚Äî poop', payload:{type:'Poop'}},
{label:'bathroom ‚Äî both', payload:{type:'Both'}},
];
} else if(activity === 'Medication'){
opts = [
{label:'trazodone 25 mg', payload:{medName:'Trazodone', mg:25}},
{label:'trazodone 50 mg', payload:{medName:'Trazodone', mg:50}},
{label:'trazodone 75 mg', payload:{medName:'Trazodone', mg:75}},
{label:'trazodone 100 mg', payload:{medName:'Trazodone', mg:100}},
];
} else if(activity === 'Vet Visit'){
opts = [
{label:'vet visit ‚Äî check-up', payload:{reason:'check-up'}},
{label:'vet visit ‚Äî vaccine', payload:{reason:'vaccine'}},
{label:'vet visit ‚Äî post-op', payload:{reason:'post-op'}},
];
}
opts.forEach(opt => {
const b = document.createElement('button');
b.className = 'quick-btn'; b.type = 'button'; b.textContent = opt.label;
b.addEventListener('click', ()=> quickAdd(activity, opt.payload));
quickRow.appendChild(b);
});
quickbar.style.display = opts.length ? '' : 'none';
}

function renderFields(activity){
dynamicFields.innerHTML = '';
if(activity === 'Feeding'){
dynamicFields.innerHTML = `
<label>Custom Feeding</label>
<div class="chips" id="feedChips">
<button type="button" class="chip" data-value="0.5">0.5 scoops</button>
<button type="button" class="chip" data-value="1.0">1.0 scoops</button>
<button type="button" class="chip" data-value="1.5">1.5 scoops</button>
</div>
<div class="row" style="margin-top:6px">
<div>
<label for="feedAmount">Amount</label>
<input id="feedAmount" type="number" min="0" step="0.5" placeholder="e.g., 1.0"/>
</div>
<div>
<label for="foodType">Food Type</label>
<input id="foodType" type="text" placeholder="kibble / wet / treat"/>
</div>
</div>`;
hookChipGroup('feedChips', 'feedAmount');
} else if(activity === 'Walk'){
dynamicFields.innerHTML = `
<label>Custom Walk</label>
<div class="chips" id="walkChips">
<button type="button" class="chip" data-value="15">15 minutes</button>
<button type="button" class="chip" data-value="30">30 minutes</button>
<button type="button" class="chip" data-value="45">45 minutes</button>
<button type="button" class="chip" data-value="60">60 minutes</button>
</div>
<div style="margin-top:6px">
<label for="walkMins">Duration</label>
<input id="walkMins" type="number" min="0" step="15" placeholder="e.g., 30"/>
</div>`;
hookChipGroup('walkChips', 'walkMins');
} else if(activity === 'Bathroom'){
dynamicFields.innerHTML = `
<label>Bathroom Type</label>
<div class="chips" id="bathChips">
<button type="button" class="chip" data-value="Pee">Pee</button>
<button type="button" class="chip" data-value="Poop">Poop</button>
<button type="button" class="chip" data-value="Both">Both</button>
</div>`;
hookChipGroup('bathChips', null);
} else if(activity === 'Medication'){
dynamicFields.innerHTML = `
<label>Medication</label>
<div class="row">
<div>
<select id="medName">
<option value="Trazodone" selected>Trazodone</option>
<option value="Other">Other‚Ä¶</option>
</select>
</div>
<div>
<input id="medNameCustom" type="text" placeholder="Name (if Other)" style="display:none"/>
</div>
</div>
<label>Dosage</label>
<div class="chips" id="medChips">
<button type="button" class="chip" data-value="25">25 mg</button>
<button type="button" class="chip" data-value="50">50 mg</button>
<button type="button" class="chip" data-value="75">75 mg</button>
<button type="button" class="chip" data-value="100">100 mg</button>
</div>
<div style="margin-top:6px">
<label for="medMg">Custom (mg)</label>
<input id="medMg" type="number" min="0" step="25" placeholder="e.g., 25"/>
</div>`;
hookChipGroup('medChips', 'medMg');
setTimeout(()=>{
const medName = document.getElementById('medName');
const medCustom = document.getElementById('medNameCustom');
medName.addEventListener('change', ()=>{ medCustom.style.display = medName.value === 'Other' ? '' : 'none'; });
});
} else if(activity === 'Vet Visit'){
dynamicFields.innerHTML = `
<label for="vetReason">Reason</label>
<input id="vetReason" type="text" placeholder="e.g., check-up, vaccine, post-op"/>`;
}
}

function hookChipGroup(groupId, inputId){
const group = document.getElementById(groupId); if(!group) return;
const chips = [...group.querySelectorAll('.chip')];
const input = inputId ? document.getElementById(inputId) : null;
chips.forEach(ch => {
ch.addEventListener('click', ()=>{
const selected = ch.getAttribute('data-selected') === 'true';
chips.forEach(c => c.setAttribute('data-selected','false'));
ch.setAttribute('data-selected', selected ? 'false' : 'true');
if(input){ input.value = selected ? '' : ch.dataset.value; }
});
});
}

// Activity selection
const activityButtons = document.getElementById('activityButtons').querySelectorAll('.activity-btn');
activityButtons.forEach(btn => {
btn.addEventListener('click', () => {
activityButtons.forEach(b => b.classList.remove('selected'));
btn.classList.add('selected');
currentActivity = btn.dataset.activity;
setDefaultDateTime();
showQuickBar(currentActivity);
renderFields(currentActivity);
});
});

// ===== Build & Save Helpers =====
function getSelectedDateTime(){
const now = new Date();
const d = document.getElementById('dateInput').value || now.toISOString().slice(0,10);
const t = document.getElementById('timeInput').value || `${pad(now.getHours())}:${pad(now.getMinutes())}`;
const [y,m,dd] = d.split('-').map(Number);
const [hh,mm] = t.split(':').map(Number);
return new Date(y, m-1, dd, hh||0, mm||0);
}
function optimisticSave(entry, notes=''){
addToCache(entry);
renderCalendar(currentMonth.getFullYear(), currentMonth.getMonth());
renderTodayStrip();
const payload = {
Timestamp: new Date(entry.timestamp).toLocaleString(),
Activity: entry.activity,
Description: entry.description,
Notes: notes || '',
User: USER_NAME
};
fetch(APPS_SCRIPT_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) }).catch(()=>{});
}

function quickAdd(activity, payload){
const status = document.getElementById('status');
const ts = getSelectedDateTime();
const dateKey = toDateKey(ts);
let description = activity, qty=null, unit='';

if(activity === 'Feeding'){ const amount = payload.amount; description = `feed ${amount} scoops`; qty=amount; unit='scoops'; }
else if(activity === 'Walk'){ const minutes = payload.minutes; description = `walk ${minutes} minutes`; qty=minutes; unit='minutes'; }
else if(activity === 'Bathroom'){ const type = payload.type; description = `bathroom ‚Äî ${type.toLowerCase()}`; }
else if(activity === 'Medication'){ const name = payload.medName||'Medication'; const mg=payload.mg||null; description = `${name.toLowerCase()} ${mg? mg + ' mg':''}`.trim(); qty=mg; unit='mg'; }
else if(activity === 'Vet Visit'){ const reason = payload.reason||''; description = reason ? `vet visit ‚Äî ${reason}` : 'vet visit'; }

const id = `${ts.toISOString()}|${activity}|${description}`;
const entry = { id, timestamp: ts.toISOString(), dateKey, activity, description, notes:'', qty, unit, ...payload };
optimisticSave(entry);
status.textContent = 'Saved! (Quick Add)'; status.className = 'status ok';
setDefaultDateTime();
}

// Custom submit
document.getElementById('submitBtn').addEventListener('click', () => {
const status = document.getElementById('status');
if(!currentActivity){ status.textContent = 'Please select an activity.'; status.className = 'status err'; return; }

const ts = getSelectedDateTime();
const dateKey = toDateKey(ts);
const notes = document.getElementById('notesInput').value.trim();

let description = '', qty = null, unit = '', extra = {};
if(currentActivity === 'Feeding'){
const amount = parseFloat(document.getElementById('feedAmount')?.value || '0') || null;
const foodType = document.getElementById('foodType')?.value?.trim() || '';
qty = amount; unit = 'scoops';
description = amount ? `feed ${amount} scoops` : 'feeding';
if(foodType) description += ` ‚Äî ${foodType}`;
extra = { amount, foodType };
} else if(currentActivity === 'Walk'){
const mins = parseFloat(document.getElementById('walkMins')?.value || '0') || null;
qty = mins; unit = 'minutes';
description = mins ? `walk ${mins} minutes` : 'walk';
extra = { minutes: mins };
} else if(currentActivity === 'Bathroom'){
const chip = document.querySelector('#bathChips .chip[data-selected="true"]');
const type = chip ? chip.getAttribute('data-value') : '';
description = type ? `bathroom ‚Äî ${type.toLowerCase()}` : 'bathroom';
extra = { type };
} else if(currentActivity === 'Medication'){
const medSel = document.getElementById('medName').value;
const medName = (medSel === 'Other' ? (document.getElementById('medNameCustom').value.trim() || 'Medication') : medSel);
const mg = parseFloat(document.getElementById('medMg')?.value || '0') || null;
qty = mg; unit = 'mg';
description = mg ? `${medName.toLowerCase()} ${mg} mg` : medName.toLowerCase();
extra = { medName, mg };
} else if(currentActivity === 'Vet Visit'){
const reason = document.getElementById('vetReason')?.value?.trim() || '';
description = reason ? `vet visit ‚Äî ${reason}` : 'vet visit';
extra = { reason };
}

const id = `${ts.toISOString()}|${currentActivity}|${description}`;
const entry = { id, timestamp: ts.toISOString(), dateKey, activity: currentActivity, description, notes, qty, unit, ...extra };
optimisticSave(entry, notes);
status.textContent = 'Saved!'; status.className = 'status ok';
document.getElementById('notesInput').value = '';
renderFields(currentActivity);
setDefaultDateTime();
});

// ===== Calendar + Sync =====
const calendarGrid = document.getElementById('calendarGrid');
const dowRow = document.getElementById('dowRow');
const monthLabel = document.getElementById('monthLabel');
const dayModal = document.getElementById('dayModal');
const logsOnDay = document.getElementById('logsOnDay');
const dayModalTitle = document.getElementById('dayModalTitle');

const dows = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
dows.forEach(d => { const el = document.createElement('div'); el.className='dow'; el.textContent = d; dowRow.appendChild(el); });

let nowRef = new Date();
let currentMonth = new Date(nowRef.getFullYear(), nowRef.getMonth(), 1);

function renderCalendar(year, monthIndex){
const firstDay = new Date(year, monthIndex, 1);
const lastDay = new Date(year, monthIndex + 1, 0);
const startWeekDay = (firstDay.getDay()+6)%7; // Monday=0
const daysInMonth = lastDay.getDate();

monthLabel.textContent = firstDay.toLocaleString(undefined, {month:'long', year:'numeric'});
calendarGrid.innerHTML = '';

const cells = [];
const daysFromPrev = startWeekDay;
const prevLast = new Date(year, monthIndex, 0).getDate();

for(let i=daysFromPrev; i>0; i--){ cells.push({date:new Date(year, monthIndex-1, prevLast - i + 1), other:true}); }
for(let d=1; d<=daysInMonth; d++){ cells.push({date:new Date(year, monthIndex, d), other:false}); }
while(cells.length % 7 !== 0){ const nextIndex = cells.length - daysFromPrev - daysInMonth + 1; cells.push({date:new Date(year, monthIndex+1, nextIndex), other:true}); }

const byDate = entriesByDateKey();

for(const cell of cells){
const el = document.createElement('div');
el.className = 'day' + (cell.other ? ' other' : '');
const dateNum = document.createElement('div'); dateNum.className = 'date-num'; dateNum.textContent = cell.date.getDate();
el.appendChild(dateNum);

const pk = toDateKey(cell.date);
const logs = byDate[pk] || [];

if(logs.length){
const counts = logs.reduce((acc,e)=>{ acc[e.activity] = (acc[e.activity]||0) + 1; return acc; },{});
const row = document.createElement('div'); row.className='pill-row';
for(const [act,count] of Object.entries(counts)){
const pill = document.createElement('div'); pill.className='pill';
pill.textContent = `${act} √ó${count}`;
row.appendChild(pill);
}
el.appendChild(row);
}

el.addEventListener('click', ()=> openDay(pk, cell.date));
calendarGrid.appendChild(el);
}
}

function openDay(dateKey, dateObj){
dayModalTitle.textContent = dateObj.toLocaleDateString(undefined, { weekday:'long', month:'short', day:'numeric', year:'numeric'});
const logs = (entriesByDateKey()[dateKey] || []).sort((a,b)=> a.timestamp.localeCompare(b.timestamp));
logsOnDay.innerHTML = '';
if(!logs.length){
logsOnDay.innerHTML = '<div class="empty">No entries yet.</div>';
}else{
for(const e of logs){
const row = document.createElement('div');
row.className = 'log-item';
const left = document.createElement('div');
const time = new Date(e.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
left.innerHTML = `<strong>${e.activity}</strong> ‚Äî ${e.description}<div class="meta">${time}${e.notes? ' ¬∑ ' + e.notes : ''}</div>`;
const right = document.createElement('div');
right.className='meta';
right.textContent = e.qty ? `${e.qty} ${e.unit}` : '';
row.appendChild(left); row.appendChild(right);
logsOnDay.appendChild(row);
}
}
document.getElementById('dateInput').value = toDateKey(dateObj);
dayModal.showModal();
}
document.getElementById('closeModal').addEventListener('click', ()=> dayModal.close());
document.getElementById('prevBtn').addEventListener('click', ()=>{ currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1, 1); renderCalendar(currentMonth.getFullYear(), currentMonth.getMonth()); });
document.getElementById('nextBtn').addEventListener('click', ()=>{ currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 1); renderCalendar(currentMonth.getFullYear(), currentMonth.getMonth()); });
document.getElementById('todayBtn').addEventListener('click', ()=>{ nowRef = new Date(); currentMonth = new Date(nowRef.getFullYear(), nowRef.getMonth(), 1); renderCalendar(currentMonth.getFullYear(), currentMonth.getMonth()); setDefaultDateTime(); });

// Sync (pull history)
document.getElementById('syncBtn').addEventListener('click', ()=> fetchHistory(365));
async function fetchHistory(days=120){
try{
const since = new Date(Date.now() - days*24*60*60*1000).toISOString().slice(0,10);
const res = await fetch(`${APPS_SCRIPT_URL}?since=${encodeURIComponent(since)}`);
const rows = await res.json();
const ids = idSet();
const add = [];
for(const r of rows){
const ts = new Date(r.Timestamp);
if(!isFinite(ts)) continue;
const dateKey = toDateKey(ts);
const activity = r.Activity || 'Log';
const description = r.Description || '';
const id = `${ts.toISOString()}|${activity}|${description}`;
if(ids.has(id)) continue;
ids.add(id);
add.push({ id, timestamp: ts.toISOString(), dateKey, activity, description, notes: r.Notes || '', qty: null, unit: '' });
}
if(add.length){
const merged = loadCache().concat(add);
saveCache(merged); saveIdSet(ids);
renderCalendar(currentMonth.getFullYear(), currentMonth.getMonth());
renderTodayStrip();
}
const status = document.getElementById('status');
status.textContent = 'Synced!'; status.className='status ok';
}catch(e){
const status = document.getElementById('status');
status.textContent = 'Sync failed'; status.className='status err';
}
}

// Today strip
function renderTodayStrip(){
const wrap = document.getElementById('todayStrip');
wrap.innerHTML = '';
const todayKey = toDateKey(new Date());
const logs = (entriesByDateKey()[todayKey] || []);
if(!logs.length){ wrap.innerHTML = '<span class="today-chip">No logs yet</span>'; return; }
const byAct = logs.reduce((a,e)=>{ (a[e.activity]=a[e.activity]||[]).push(e); return a; },{});
for(const [act, arr] of Object.entries(byAct)){
const chip = document.createElement('div');
chip.className = 'today-chip';
chip.textContent = `${act} √ó${arr.length}`;
wrap.appendChild(chip);
}
}

// Init
setDefaultDateTime();
renderCalendar(currentMonth.getFullYear(), currentMonth.getMonth());
renderTodayStrip();
// Auto fetch recent history on first load (mobile safe)
fetchHistory(120).catch(()=>{});
</script>
</body>
</html>

