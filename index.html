<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
<title>PawLog ‚Äî Weekly (Sunday Start)</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#4CAF50">

<style>
:root{
  --brand:#4CAF50;
  --brand-2:#2e7d32;
  --bg:#f7f8fa;
  --card:#ffffff;
  --text:#111;
  --muted:#6b7280;
  --line:#e5e7eb;
  --chip:#e8f5e9;
  --chip-2:#c8e6c9;
  --danger:#ef4444;
  --safe-top: env(safe-area-inset-top);
  --safe-bottom: env(safe-area-inset-bottom);
  --safe-left: env(safe-area-inset-left);
  --safe-right: env(safe-area-inset-right);
}

*{box-sizing:border-box; -webkit-tap-highlight-color: rgba(0,0,0,0);}
html,body{height:100%}
html{-webkit-text-size-adjust:100%}

body{
  margin:0;
  font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, system-ui, sans-serif;
  background:var(--bg); color:var(--text);
  padding: calc(8px + var(--safe-top)) 10px calc(86px + var(--safe-bottom)) 10px;
  overscroll-behavior-y: contain;
}

/* Header */
header{
  position: sticky; top:0; z-index:10;
  padding: 10px 8px;
  margin: -10px -10px 8px -10px;
  padding-top: calc(10px + var(--safe-top));
  background: linear-gradient(to bottom, rgba(247,248,250,0.97), rgba(247,248,250,0.6));
  backdrop-filter: saturate(180%) blur(8px);
  border-bottom:1px solid var(--line);
  display:flex; align-items:center; justify-content:space-between; gap:8px;
}
.h-title{display:flex; align-items:center; gap:8px}
.h-title h1{font-size:20px; color:var(--brand); margin:0}
.h-sub{font-size:12px; color:var(--muted)}

/* Card */
.card{ background:var(--card); border-radius:14px; border:1px solid var(--line); padding:12px; }

/* Activity row */
.activity-buttons{
  display:flex; gap:8px; overflow:auto; padding-bottom:6px; margin-bottom:8px;
  -webkit-overflow-scrolling: touch; scroll-snap-type:x proximity;
}
.activity-btn{
  flex:0 0 auto; padding:12px 14px; border-radius:12px; border:2px solid var(--chip);
  background:var(--chip); color:var(--brand-2); font-weight:700; font-size:14px; cursor:pointer;
  scroll-snap-align:start;
}
.activity-btn.selected{background:var(--chip-2); border-color:var(--brand);}
.section-title{font-weight:800; margin:2px 0 8px 2px; font-size:14px}

/* Inputs */
label{font-size:12px; text-transform:uppercase; letter-spacing:.04em; color:var(--muted); display:block; margin:8px 2px 4px}
input[type="text"], input[type="number"], input[type="time"], input[type="date"], textarea, select{
  width:100%; padding:14px 12px; border-radius:12px; border:1px solid var(--line); font-size:16px; background:#fff;
}
textarea{min-height:68px; resize:vertical;}
.row{display:flex; gap:8px;}
.row > *{flex:1}
.chips{display:flex; flex-wrap:wrap; gap:8px; margin:6px 0 0}
.chip{
  display:inline-flex; align-items:center; gap:6px; padding:10px 12px; border-radius:999px; border:1px solid var(--line); background:#f9fafb; cursor:pointer;
  font-weight:700; font-size:14px;
}
.chip[data-selected="true"]{background:var(--chip); border-color:var(--brand); color:var(--brand-2);}

.submit-btn{
  width:100%; margin-top:10px; background:var(--brand); color:#fff; border:none; border-radius:12px; padding:14px 16px;
  font-weight:800; font-size:16px; cursor:pointer;
}
.submit-btn:active{transform: translateY(1px)}
.status{min-height:22px; font-weight:800; margin-top:8px;}
.status.ok{color:#16a34a}
.status.err{color:var(--danger)}
.inline-hint{font-size:12px; color:var(--muted)}

/* Sticky Quick Add bar */
.quickbar{
  position: fixed; left:0; right:0; bottom:0; z-index:20;
  padding: 8px 10px calc(8px + var(--safe-bottom)) 10px;
  background: rgba(255,255,255,0.98);
  backdrop-filter: blur(8px);
  border-top:1px solid var(--line);
}
.quick-title{font-size:11px; color:var(--muted); margin:0 0 6px 2px; text-transform:uppercase; letter-spacing:.04em}
.quick-row{display:flex; gap:8px; overflow:auto; -webkit-overflow-scrolling: touch;}
.quick-btn{ flex:0 0 auto; border:1px solid var(--line); background:#fff; border-radius:999px; padding:10px 12px; font-weight:800; font-size:14px; }

/* WEEK VIEW */
.week{margin-top:10px}
.week-head{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;}
.week-nav{display:flex; gap:8px; flex-wrap:wrap;}
.cal-btn{ padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; font-weight:700;}

.dow-row{display:grid; grid-template-columns: repeat(7, 1fr); gap:4px; padding:0 2px}
.dow{font-size:11px; font-weight:800; color:var(--muted); text-align:center; padding:4px 0}
.grid-week{display:grid; grid-template-columns: repeat(7, 1fr); gap:4px;}
.day{ background:#fff; border:1px solid var(--line); border-radius:10px; min-height:90px; padding:6px; display:flex; flex-direction:column; gap:4px; }
.day .date-num{font-weight:800; font-size:12px}
.pill-row{display:flex; flex-wrap:wrap; gap:4px}
.pill{ font-size:10px; font-weight:800; padding:3px 6px; border-radius:999px; background:var(--chip); border:1px solid var(--line); white-space:nowrap;}
.day:active{outline:2px solid var(--chip-2)}

.legend{display:flex; flex-wrap:wrap; gap:6px; font-size:12px; margin-top:8px}
.legend .pill{background:#f9fafb}

/* Day modal + edit */
dialog{border:none; border-radius:16px; width:100%; max-width:560px; padding:0; box-shadow:0 8px 32px rgba(0,0,0,.25)}
dialog::backdrop{background:rgba(0,0,0,.35)}
.modal-head{position:sticky; top:0; background:#fff; padding:12px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:8px}
.modal-body{padding:12px; max-height:70vh; overflow:auto}
.log-item{border:1px solid var(--line); border-radius:12px; padding:10px; display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:8px; gap:12px}
.log-left{min-width:0; flex:1}
.log-item .meta{font-size:12px; color:var(--muted)}
.log-actions{display:flex; gap:6px; flex:0 0 auto}
.del-btn, .edit-btn, .save-btn, .cancel-btn{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:8px 10px; font-weight:800; font-size:12px; }
.del-btn{ color:#b91c1c; }
.edit-form{display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-top:8px}
.edit-form .row-span{grid-column:1/-1}
.empty{color:var(--muted); font-style:italic}

/* Today strip */
.today-strip{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px}
.today-chip{padding:6px 8px; border-radius:999px; background:#f9fafb; border:1px solid var(--line); font-weight:800; font-size:12px}

/* Dark mode */
@media (prefers-color-scheme: dark){
  :root{ --bg:#0b0e11; --card:#0f1317; --text:#eee; --muted:#9aa4b2; --line:#1f2937; --chip:#0e2011; --chip-2:#14361a; }
  .quickbar{background: rgba(16,20,24,0.98);}
  .cal-btn{background:#0f1317}
  .del-btn,.edit-btn,.save-btn,.cancel-btn{background:#0f1317}
}
</style>
</head>
<body>
<header>
  <div class="h-title">
    <div>üê∂</div>
    <h1>PawLog</h1>
  </div>
  <div class="h-sub">Weekly ‚Ä¢ Sunday Start</div>
</header>

<main>
  <!-- Quick Log -->
  <section class="card">
    <div class="section-title">Quick Log</div>

    <div class="activity-buttons" id="activityButtons">
      <button type="button" class="activity-btn" data-activity="Feeding">üêæ Feeding</button>
      <button type="button" class="activity-btn" data-activity="Walk">üö∂ Walk</button>
      <button type="button" class="activity-btn" data-activity="Bathroom">üí© Bathroom</button>
      <button type="button" class="activity-btn" data-activity="Medication">üíä Medication</button>
      <button type="button" class="activity-btn" data-activity="Vet Visit">üè• Vet Visit</button>
    </div>

    <div class="row">
      <div>
        <label for="dateInput">Date</label>
        <input id="dateInput" type="date"/>
      </div>
      <div>
        <label for="timeInput">Time</label>
        <input id="timeInput" type="time" />
      </div>
    </div>

    <div id="dynamicFields"></div>

    <label for="notesInput">Notes (optional)</label>
    <textarea id="notesInput" placeholder="Any extra details..."></textarea>

    <button class="submit-btn" id="submitBtn">Log Activity</button>
    <div class="status" id="status"></div>
    <div class="inline-hint">Uses your Apps Script + local cache.</div>

    <div class="section-title" style="margin-top:12px">Today</div>
    <div id="todayStrip" class="today-strip"></div>
  </section>

  <!-- WEEK VIEW -->
  <section class="week">
    <div class="week-head">
      <div class="section-title" id="weekLabel">This Week</div>
      <div class="week-nav">
        <button class="cal-btn" id="resetBtn">Reset</button>
        <button class="cal-btn" id="syncBtn">Sync</button>
        <button class="cal-btn" id="prevWeekBtn">‚óÄÔ∏é</button>
        <button class="cal-btn" id="thisWeekBtn">This Week</button>
        <button class="cal-btn" id="nextWeekBtn">‚ñ∂Ô∏é</button>
      </div>
    </div>

    <div class="dow-row" id="dowRow"></div>
    <div class="grid-week" id="weekGrid"></div>

    <div class="legend">
      <span class="pill">Feeding</span>
      <span class="pill">Walk</span>
      <span class="pill">Bathroom</span>
      <span class="pill">Medication</span>
      <span class="pill">Vet Visit</span>
    </div>
  </section>
</main>

<!-- Sticky Quick Bar -->
<div id="quickbar" class="quickbar" style="display:none">
  <div class="quick-title">Quick Add ‚Äî uses current date/time</div>
  <div id="quickRow" class="quick-row"></div>
</div>

<!-- Day Modal -->
<dialog id="dayModal">
  <div class="modal-head">
    <div id="dayModalTitle">Logs</div>
    <button class="cal-btn" id="closeModal">Close</button>
  </div>
  <div class="modal-body">
    <div id="logsOnDay"></div>
  </div>
</dialog>

<script>
// ===== Config =====
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwMNcmdsfZa3lkPjL588G-nzkeEtzXrvrORTdPvCGuQf7G_Jae9_WvARk-Xd8YXGdLhug/exec';
const USER_NAME = 'Default User';
const LS_KEY = 'pawlog-entries-v2';        // versioned
const DEDUPE_KEY = 'pawlog-ids-v2';

// ===== Utilities =====
const pad = (n) => String(n).padStart(2,'0');
const toDateKey = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

// Local-date safe formatter for <input type="date">
function dateInputValueFromLocal(date){
  const y = date.getFullYear();
  const m = pad(date.getMonth()+1);
  const d = pad(date.getDate());
  return `${y}-${m}-${d}`;
}

function setDefaultDateTime(){
  const d = document.getElementById('dateInput');
  const t = document.getElementById('timeInput');
  const now = new Date();
  d.value = dateInputValueFromLocal(now);
  t.value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
}

function loadCache(){ try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch(e){ return []; } }
function saveCache(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
function addToCache(entry){ const arr = loadCache(); arr.push(entry); saveCache(arr); }
function entriesByDateKey(){
  const out = {}; 
  for(const e of loadCache()){
    const k = e.dateKey; (out[k]||(out[k]=[])).push(e); 
  } 
  return out;
}
function idSet(){ try{return new Set(JSON.parse(localStorage.getItem(DEDUPE_KEY)||'[]'))}catch(e){return new Set()} }
function saveIdSet(s){ localStorage.setItem(DEDUPE_KEY, JSON.stringify(Array.from(s))); }
function uuid(){ return (crypto?.randomUUID?.() || ('uid-'+Date.now()+'-'+Math.random().toString(16).slice(2))); }
function keyOf(e){ return e.uid || e.id; } // legacy safe

// Keep inputs visible when iOS keyboard opens
document.addEventListener('focusin', (e) => {
  if (e.target.matches('input, textarea, select')) {
    setTimeout(()=> e.target.scrollIntoView({block:'center', behavior:'smooth'}), 50);
  }
});

// ===== UI: Activity + QuickBar =====
const dynamicFields = document.getElementById('dynamicFields');
const quickbar = document.getElementById('quickbar');
const quickRow = document.getElementById('quickRow');
let currentActivity = null;

function showQuickBar(activity){
  quickRow.innerHTML = '';
  let opts = [];
  if(activity === 'Feeding'){
    opts = [
      {label:'feed 0.5 scoops', payload:{amount:0.5}},
      {label:'feed 1.0 scoops', payload:{amount:1.0}},
      {label:'feed 1.5 scoops', payload:{amount:1.5}},
    ];
  } else if(activity === 'Walk'){
    opts = [
      {label:'walk 15 minutes', payload:{minutes:15}},
      {label:'walk 30 minutes', payload:{minutes:30}},
      {label:'walk 45 minutes', payload:{minutes:45}},
      {label:'walk 60 minutes', payload:{minutes:60}},
    ];
  } else if(activity === 'Bathroom'){
    opts = [
      {label:'bathroom ‚Äî pee', payload:{type:'Pee'}},
      {label:'bathroom ‚Äî poop', payload:{type:'Poop'}},
      {label:'bathroom ‚Äî both', payload:{type:'Both'}},
    ];
  } else if(activity === 'Medication'){
    opts = [
      {label:'trazodone 25 mg', payload:{medName:'Trazodone', mg:25}},
      {label:'trazodone 50 mg', payload:{medName:'Trazodone', mg:50}},
      {label:'trazodone 75 mg', payload:{medName:'Trazodone', mg:75}},
      {label:'trazodone 100 mg', payload:{medName:'Trazodone', mg:100}},
    ];
  } else if(activity === 'Vet Visit'){
    opts = [
      {label:'vet visit ‚Äî check-up', payload:{reason:'check-up'}},
      {label:'vet visit ‚Äî vaccine', payload:{reason:'vaccine'}},
      {label:'vet visit ‚Äî post-op', payload:{reason:'post-op'}},
    ];
  }
  opts.forEach(opt => {
    const b = document.createElement('button');
    b.className = 'quick-btn'; b.type = 'button'; b.textContent = opt.label;
    b.addEventListener('click', ()=> quickAdd(activity, opt.payload));
    quickRow.appendChild(b);
  });
  quickbar.style.display = opts.length ? '' : 'none';
}

function renderFields(activity){
  dynamicFields.innerHTML = '';
  if(activity === 'Feeding'){
    dynamicFields.innerHTML = `
    <label>Custom Feeding</label>
    <div class="chips" id="feedChips">
      <button type="button" class="chip" data-value="0.5">0.5 scoops</button>
      <button type="button" class="chip" data-value="1.0">1.0 scoops</button>
      <button type="button" class="chip" data-value="1.5">1.5 scoops</button>
    </div>
    <div class="row" style="margin-top:6px">
      <div>
        <label for="feedAmount">Amount</label>
        <input id="feedAmount" type="number" min="0" step="0.5" placeholder="e.g., 1.0"/>
      </div>
      <div>
        <label for="foodType">Food Type</label>
        <input id="foodType" type="text" placeholder="kibble / wet / treat"/>
      </div>
    </div>`;
    hookChipGroup('feedChips', 'feedAmount');
  } else if(activity === 'Walk'){
    dynamicFields.innerHTML = `
    <label>Custom Walk</label>
    <div class="chips" id="walkChips">
      <button type="button" class="chip" data-value="15">15 minutes</button>
      <button type="button" class="chip" data-value="30">30 minutes</button>
      <button type="button" class="chip" data-value="45">45 minutes</button>
      <button type="button" class="chip" data-value="60">60 minutes</button>
    </div>
    <div style="margin-top:6px">
      <label for="walkMins">Duration</label>
      <input id="walkMins" type="number" min="0" step="15" placeholder="e.g., 30"/>
    </div>`;
    hookChipGroup('walkChips', 'walkMins');
  } else if(activity === 'Bathroom'){
    dynamicFields.innerHTML = `
    <label>Bathroom Type</label>
    <div class="chips" id="bathChips">
      <button type="button" class="chip" data-value="Pee">Pee</button>
      <button type="button" class="chip" data-value="Poop">Poop</button>
      <button type="button" class="chip" data-value="Both">Both</button>
    </div>`;
    hookChipGroup('bathChips', null);
  } else if(activity === 'Medication'){
    dynamicFields.innerHTML = `
    <label>Medication</label>
    <div class="row">
      <div>
        <select id="medName">
          <option value="Trazodone" selected>Trazodone</option>
          <option value="Other">Other‚Ä¶</option>
        </select>
      </div>
      <div>
        <input id="medNameCustom" type="text" placeholder="Name (if Other)" style="display:none"/>
      </div>
    </div>
    <label>Dosage</label>
    <div class="chips" id="medChips">
      <button type="button" class="chip" data-value="25">25 mg</button>
      <button type="button" class="chip" data-value="50">50 mg</button>
      <button type="button" class="chip" data-value="75">75 mg</button>
      <button type="button" class="chip" data-value="100">100 mg</button>
    </div>
    <div style="margin-top:6px">
      <label for="medMg">Custom (mg)</label>
      <input id="medMg" type="number" min="0" step="25" placeholder="e.g., 25"/>
    </div>`;
    hookChipGroup('medChips', 'medMg');
    setTimeout(()=>{
      const medName = document.getElementById('medName');
      const medCustom = document.getElementById('medNameCustom');
      medName.addEventListener('change', ()=>{ medCustom.style.display = medName.value === 'Other' ? '' : 'none'; });
    });
  } else if(activity === 'Vet Visit'){
    dynamicFields.innerHTML = `
    <label for="vetReason">Reason</label>
    <input id="vetReason" type="text" placeholder="e.g., check-up, vaccine, post-op"/>`;
  }
}

function hookChipGroup(groupId, inputId){
  const group = document.getElementById(groupId); if(!group) return;
  const chips = [...group.querySelectorAll('.chip')];
  const input = inputId ? document.getElementById(inputId) : null;
  chips.forEach(ch => {
    ch.addEventListener('click', ()=>{
      const selected = ch.getAttribute('data-selected') === 'true';
      chips.forEach(c => c.setAttribute('data-selected','false'));
      ch.setAttribute('data-selected', selected ? 'false' : 'true');
      if(input){ input.value = selected ? '' : ch.dataset.value; }
    });
  });
}

// Activity selection
const activityButtons = document.getElementById('activityButtons').querySelectorAll('.activity-btn');
activityButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    activityButtons.forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    currentActivity = btn.dataset.activity;
    setDefaultDateTime();
    showQuickBar(currentActivity);
    renderFields(currentActivity);
  });
});

// ===== Build & Save Helpers =====
function getSelectedDateTime(){
  const now = new Date();
  const dVal = document.getElementById('dateInput').value;
  const tVal = document.getElementById('timeInput').value;
  let y, m, dd, hh, mm;
  if(dVal){
    [y,m,dd] = dVal.split('-').map(Number);
  } else {
    y = now.getFullYear(); m = now.getMonth()+1; dd = now.getDate();
  }
  if(tVal){
    [hh,mm] = tVal.split(':').map(Number);
  } else {
    hh = now.getHours(); mm = now.getMinutes();
  }
  return new Date(y, (m||1)-1, dd||1, hh||0, mm||0);
}

function optimisticSave(entry, notes=''){
  addToCache(entry);
  renderWeek(currentWeekStart);
  renderTodayStrip();
  const payload = {
    _action: 'create',
    key: keyOf(entry),
    Timestamp: new Date(entry.timestamp).toLocaleString(),
    Activity: entry.activity,
    Description: entry.description,
    Notes: notes || '',
    User: USER_NAME
  };
  // Fire-and-forget to Apps Script
  fetch(APPS_SCRIPT_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) }).catch(()=>{});
}

function quickAdd(activity, payload){
  const status = document.getElementById('status');
  const ts = getSelectedDateTime();
  const dateKey = toDateKey(ts);
  let description = activity, qty=null, unit='';

  if(activity === 'Feeding'){ const amount = payload.amount; description = `feed ${amount} scoops`; qty=amount; unit='scoops'; }
  else if(activity === 'Walk'){ const minutes = payload.minutes; description = `walk ${minutes} minutes`; qty=minutes; unit='minutes'; }
  else if(activity === 'Bathroom'){ const type = payload.type; description = `bathroom ‚Äî ${type.toLowerCase()}`; }
  else if(activity === 'Medication'){ const name = payload.medName||'Medication'; const mg=payload.mg||null; description = `${name.toLowerCase()} ${mg? mg + ' mg':''}`.trim(); qty=mg; unit='mg'; }
  else if(activity === 'Vet Visit'){ const reason = payload.reason||''; description = reason ? `vet visit ‚Äî ${reason}` : 'vet visit'; }

  const entry = { uid: uuid(), id: `${ts.toISOString()}|${activity}|${description}`, timestamp: ts.toISOString(), dateKey, activity, description, notes:'', qty, unit, ...payload };
  optimisticSave(entry);
  status.textContent = 'Saved! (Quick Add)'; status.className = 'status ok';
  setDefaultDateTime();
}

// Custom submit
document.getElementById('submitBtn').addEventListener('click', () => {
  const status = document.getElementById('status');
  if(!currentActivity){ status.textContent = 'Please select an activity.'; status.className = 'status err'; return; }

  const ts = getSelectedDateTime();
  const dateKey = toDateKey(ts);
  const notes = document.getElementById('notesInput').value.trim();

  let description = '', qty = null, unit = '', extra = {};
  if(currentActivity === 'Feeding'){
    const amount = parseFloat(document.getElementById('feedAmount')?.value || '0') || null;
    const foodType = document.getElementById('foodType')?.value?.trim() || '';
    qty = amount; unit = 'scoops';
    description = amount ? `feed ${amount} scoops` : 'feeding';
    if(foodType) description += ` ‚Äî ${foodType}`;
    extra = { amount, foodType };
  } else if(currentActivity === 'Walk'){
    const mins = parseFloat(document.getElementById('walkMins')?.value || '0') || null;
    qty = mins; unit = 'minutes';
    description = mins ? `walk ${mins} minutes` : 'walk';
    extra = { minutes: mins };
  } else if(currentActivity === 'Bathroom'){
    const chip = document.querySelector('#bathChips .chip[data-selected="true"]');
    const type = chip ? chip.getAttribute('data-value') : '';
    description = type ? `bathroom ‚Äî ${type.toLowerCase()}` : 'bathroom';
    extra = { type };
  } else if(currentActivity === 'Medication'){
    const medSel = document.getElementById('medName').value;
    const medName = (medSel === 'Other' ? (document.getElementById('medNameCustom').value.trim() || 'Medication') : medSel);
    const mg = parseFloat(document.getElementById('medMg')?.value || '0') || null;
    qty = mg; unit = 'mg';
    description = mg ? `${medName.toLowerCase()} ${mg} mg` : medName.toLowerCase();
    extra = { medName, mg };
  } else if(currentActivity === 'Vet Visit'){
    const reason = document.getElementById('vetReason')?.value?.trim() || '';
    description = reason ? `vet visit ‚Äî ${reason}` : 'vet visit';
    extra = { reason };
  }

  const entry = { uid: uuid(), id: `${ts.toISOString()}|${currentActivity}|${description}`, timestamp: ts.toISOString(), dateKey, activity: currentActivity, description, notes, qty, unit, ...extra };
  optimisticSave(entry, notes);
  status.textContent = 'Saved!'; status.className = 'status ok';
  document.getElementById('notesInput').value = '';
  renderFields(currentActivity);
  setDefaultDateTime();
});

// ===== WEEK VIEW + Sync (SUNDAY START) =====
const weekGrid = document.getElementById('weekGrid');
const dowRow = document.getElementById('dowRow');
const weekLabel = document.getElementById('weekLabel');
const dayModal = document.getElementById('dayModal');
const logsOnDay = document.getElementById('logsOnDay');
const dayModalTitle = document.getElementById('dayModalTitle');

const dows = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
dows.forEach(d => { const el = document.createElement('div'); el.className='dow'; el.textContent = d; dowRow.appendChild(el); });

// find Sunday of a given date (Sun=0)
function sundayOf(date){
  const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
  const day = d.getDay(); // 0..6
  d.setDate(d.getDate() - day); // back to Sunday
  return d;
}

let nowRef = new Date();
let currentWeekStart = sundayOf(nowRef);

function renderWeek(weekStart){
  // Label like "Aug 18‚Äì24, 2025"
  const range = [];
  for(let i=0;i<7;i++){
    const d = new Date(weekStart); d.setDate(d.getDate()+i); range.push(d);
  }
  const first = range[0];
  const last = range[6];
  const sameMonth = first.getMonth() === last.getMonth();
  const label = sameMonth 
    ? `${first.toLocaleString(undefined,{month:'short'})} ${first.getDate()}‚Äì${last.getDate()}, ${last.getFullYear()}`
    : `${first.toLocaleString(undefined,{month:'short'})} ${first.getDate()} ‚Äì ${last.toLocaleString(undefined,{month:'short'})} ${last.getDate()}, ${last.getFullYear()}`;
  weekLabel.textContent = label;

  weekGrid.innerHTML = '';
  const byDate = entriesByDateKey();

  for(const date of range){
    const el = document.createElement('div');
    el.className = 'day';
    const dateNum = document.createElement('div'); dateNum.className = 'date-num'; 
    const today = new Date();
    const isToday = toDateKey(date) === toDateKey(today);
    dateNum.textContent = (isToday ? '‚Ä¢ ' : '') + date.getDate();
    el.appendChild(dateNum);

    const pk = toDateKey(date);
    const logs = byDate[pk] || [];

    if(logs.length){
      const counts = logs.reduce((acc,e)=>{ acc[e.activity] = (acc[e.activity]||0) + 1; return acc; },{});
      const row = document.createElement('div'); row.className='pill-row';
      for(const [act,count] of Object.entries(counts)){
        const pill = document.createElement('div'); pill.className='pill';
        pill.textContent = `${act} √ó${count}`;
        row.appendChild(pill);
      }
      el.appendChild(row);
    }

    el.addEventListener('click', ()=> openDay(pk, date));
    weekGrid.appendChild(el);
  }
}

function openDay(dateKey, dateObj){
  dayModalTitle.textContent = dateObj.toLocaleDateString(undefined, { weekday:'long', month:'short', day:'numeric', year:'numeric'});
  const logs = (entriesByDateKey()[dateKey] || []).sort((a,b)=> a.timestamp.localeCompare(b.timestamp));
  logsOnDay.innerHTML = '';
  if(!logs.length){
    logsOnDay.innerHTML = '<div class="empty">No entries yet.</div>';
  }else{
    for(const e of logs){
      const row = document.createElement('div');
      row.className = 'log-item';
      row.dataset.key = keyOf(e);

      const left = document.createElement('div');
      left.className = 'log-left';
      const time = new Date(e.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      left.innerHTML = `<strong>${e.activity}</strong> ‚Äî ${e.description}<div class="meta">${time}${e.notes? ' ¬∑ ' + e.notes : ''}</div>`;

      const actions = document.createElement('div');
      actions.className = 'log-actions';
      const edit = document.createElement('button');
      edit.className = 'edit-btn'; edit.type = 'button'; edit.textContent = '‚úèÔ∏è Edit';
      edit.addEventListener('click', ()=> showEditForm(row, e));

      const del = document.createElement('button');
      del.className = 'del-btn'; del.type = 'button'; del.textContent = 'üóëÔ∏è Delete';
      del.addEventListener('click', ()=> deleteLog(keyOf(e), dateKey));

      actions.appendChild(edit);
      actions.appendChild(del);
      row.appendChild(left);
      row.appendChild(actions);
      logsOnDay.appendChild(row);
    }
  }
  document.getElementById('dateInput').value = dateInputValueFromLocal(dateObj);
  if(typeof dayModal.showModal === 'function'){ dayModal.showModal(); }
}

document.getElementById('closeModal').addEventListener('click', ()=> dayModal.close?.());

function showEditForm(row, entry){
  if(row.querySelector('.edit-form')) return;
  const form = document.createElement('div');
  form.className = 'edit-form';

  const ts = new Date(entry.timestamp);
  const dateVal = dateInputValueFromLocal(ts);
  const timeVal = `${pad(ts.getHours())}:${pad(ts.getMinutes())}`;

  form.innerHTML = `
    <div>
      <label style="margin:0 0 4px 0">Date</label>
      <input type="date" class="ef-date" value="${dateVal}">
    </div>
    <div>
      <label style="margin:0 0 4px 0">Time</label>
      <input type="time" class="ef-time" value="${timeVal}">
    </div>
    <div class="row-span">
      <label style="margin:6px 0 4px 0">Activity</label>
      <select class="ef-activity">
        ${['Feeding','Walk','Bathroom','Medication','Vet Visit'].map(a=>`<option ${a===entry.activity?'selected':''}>${a}</option>`).join('')}
      </select>
    </div>
    <div class="row-span">
      <label style="margin:6px 0 4px 0">Description</label>
      <input type="text" class="ef-desc" value="${(entry.description||'').replace(/"/g,'&quot;')}">
    </div>
    <div class="row-span">
      <label style="margin:6px 0 4px 0">Notes</label>
      <input type="text" class="ef-notes" value="${(entry.notes||'').replace(/"/g,'&quot;')}">
    </div>
  `;

  const btns = document.createElement('div');
  btns.className = 'log-actions';
  const save = document.createElement('button'); save.className='save-btn'; save.textContent='Save';
  const cancel = document.createElement('button'); cancel.className='cancel-btn'; cancel.textContent='Cancel';

  save.addEventListener('click', ()=>{
    const d = form.querySelector('.ef-date').value;
    const tm = form.querySelector('.ef-time').value;
    const act = form.querySelector('.ef-activity').value;
    const desc = form.querySelector('.ef-desc').value.trim();
    const notes = form.querySelector('.ef-notes').value.trim();

    const [y,m,dd] = d.split('-').map(Number);
    const [hh,mm] = tm.split(':').map(Number);
    const newDate = new Date(y, m-1, dd, hh||0, mm||0);
    const newKey = toDateKey(newDate);

    const all = loadCache();
    const idx = all.findIndex(x => keyOf(x) === row.dataset.key);
    if(idx >= 0){
      const old = all[idx];
      const updated = {
        ...old,
        activity: act,
        description: desc || old.description,
        notes,
        timestamp: newDate.toISOString(),
        dateKey: newKey
      };
      updated.id = `${updated.timestamp}|${updated.activity}|${updated.description}`;
      all[idx] = updated;
      saveCache(all);
      try{
        const ids = idSet();
        ids.delete(old.id);
        ids.add(updated.id);
        saveIdSet(ids);
      }catch(_){}
      renderWeek(currentWeekStart);
      renderTodayStrip();
      openDay(newKey, new Date(newKey));
      fetch(APPS_SCRIPT_URL, {
        method:'POST', mode:'no-cors',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          _action:'update',
          key: keyOf(updated),
          Timestamp: newDate.toLocaleString(),
          Activity: updated.activity,
          Description: updated.description,
          Notes: updated.notes || ''
        })
      }).catch(()=>{});
    }
  });

  cancel.addEventListener('click', ()=>{
    form.remove();
    btns.remove();
  });

  row.appendChild(form);
  row.appendChild(btns);
  btns.appendChild(save);
  btns.appendChild(cancel);
}

// Delete (local + server)
async function deleteLog(entryKey, dateKeyForModal){
  const status = document.getElementById('status');
  const remaining = loadCache().filter(e => keyOf(e) !== entryKey);
  saveCache(remaining);
  try { const ids = idSet(); saveIdSet(ids); } catch(_){}

  renderWeek(currentWeekStart);
  renderTodayStrip();
  if (dateKeyForModal) openDay(dateKeyForModal, new Date(dateKeyForModal));

  try {
    await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ _action:'delete', key: entryKey })
    });
    status.textContent = 'Deleted';
    status.className = 'status ok';
  } catch (e) {
    status.textContent = 'Deleted locally (server unreachable)';
    status.className = 'status err';
  }
}

// Sync (pull history; merge mode)
document.getElementById('syncBtn').addEventListener('click', ()=> fetchHistory(365));
async function fetchHistory(days=120){
  try{
    const since = new Date(Date.now() - days*24*60*60*1000);
    const sinceStr = dateInputValueFromLocal(since);
    const res = await fetch(`${APPS_SCRIPT_URL}?since=${encodeURIComponent(sinceStr)}`, { cache: 'no-cache' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const rows = await res.json();
    const ids = idSet();
    const add = [];
    for(const r of rows){
      const ts = new Date(r.Timestamp);
      if(!isFinite(ts)) continue;
      const dateKey = toDateKey(ts);
      const activity = r.Activity || 'Log';
      const description = r.Description || '';
      const id = `${ts.toISOString()}|${activity}|${description}`;
      if(ids.has(id)) continue;
      ids.add(id);
      add.push({ uid: uuid(), id, timestamp: ts.toISOString(), dateKey, activity, description, notes: r.Notes || '', qty: null, unit: '' });
    }
    if(add.length){
      const merged = loadCache().concat(add);
      saveCache(merged); saveIdSet(ids);
    }
    renderWeek(currentWeekStart);
    renderTodayStrip();
    const status = document.getElementById('status');
    status.textContent = 'Synced!';
    status.className='status ok';
  }catch(e){
    const status = document.getElementById('status');
    status.textContent = 'Sync failed';
    status.className='status err';
  }
}

// Today strip
function renderTodayStrip(){
  const wrap = document.getElementById('todayStrip');
  wrap.innerHTML = '';
  const todayKey = toDateKey(new Date());
  const logs = (entriesByDateKey()[todayKey] || []);
  if(!logs.length){ wrap.innerHTML = '<span class="today-chip">No logs yet</span>'; return; }
  const byAct = logs.reduce((a,e)=>{ (a[e.activity]=a[e.activity]||[]).push(e); return a; },{});
  for(const [act, arr] of Object.entries(byAct)){
    const chip = document.createElement('div');
    chip.className = 'today-chip';
    chip.textContent = `${act} √ó${arr.length}`;
    wrap.appendChild(chip);
  }
}

// Week nav
document.getElementById('prevWeekBtn').addEventListener('click', ()=>{ 
  const d = new Date(currentWeekStart); d.setDate(d.getDate()-7); currentWeekStart = d; renderWeek(currentWeekStart); 
});
document.getElementById('nextWeekBtn').addEventListener('click', ()=>{ 
  const d = new Date(currentWeekStart); d.setDate(d.getDate()+7); currentWeekStart = d; renderWeek(currentWeekStart); 
});
document.getElementById('thisWeekBtn').addEventListener('click', ()=>{ 
  nowRef = new Date(); currentWeekStart = (function sundayOf(date){ const dd=new Date(date.getFullYear(), date.getMonth(), date.getDate()); const w=dd.getDay(); dd.setDate(dd.getDate()-w); return dd; })(nowRef);
  renderWeek(currentWeekStart); setDefaultDateTime(); 
});

// Reset local cache
document.getElementById('resetBtn').addEventListener('click', () => {
  localStorage.removeItem(LS_KEY);
  localStorage.removeItem(DEDUPE_KEY);
  renderWeek(currentWeekStart);
  renderTodayStrip();
  logsOnDay.innerHTML = '';
  const status = document.getElementById('status');
  status.textContent = 'Local data cleared ‚Äî tap Sync to reload from Sheet.';
  status.className = 'status ok';
});

// Init
setDefaultDateTime();
renderWeek((function sundayOf(date){ const d=new Date(date.getFullYear(), date.getMonth(), date.getDate()); const w=d.getDay(); d.setDate(d.getDate()-w); return d; })(new Date()));
renderTodayStrip();
// Auto fetch recent history on first load
fetchHistory(120).catch(()=>{});
</script>
</body>
</html>
